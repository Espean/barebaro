import WaveSurfer from "https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.esm.js";
import RegionsPlugin from "https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.esm.js";

const recordBtn = document.getElementById('record');
const resetBtn = document.getElementById('reset');
const waveform = document.getElementById('waveform');
const hint = document.querySelector('.hint');
const tips = document.querySelector('.tips');
let ws, regions, mediaRecorder, audioUrl = null, isRecording = false, chunks = [];

function styleHandles(region) {
  setTimeout(() => {
    // Left
    const left = region.element.children[0];
    if (left) {
      left.style.position = "absolute";
      left.style.zIndex = "2";
      left.style.width = "6px";
      left.style.height = "100%";
      left.style.top = "0px";
      left.style.left = "0px";
      left.style.cursor = "ew-resize";
      left.style.borderLeft = "50px solid rgba(0, 105, 255, 0.15)";
      left.style.borderRadius = "2px 0 0 2px";
      left.style.background = "transparent";
    }
    // Right
    const right = region.element.children[1];
    if (right) {
      right.style.position = "absolute";
      right.style.zIndex = "2";
      right.style.width = "6px";
      right.style.height = "100%";
      right.style.top = "0px";
      right.style.right = "0px";
      right.style.cursor = "ew-resize";
      right.style.borderRight = "50px solid rgba(0, 105, 255, 0.15)";
      right.style.borderRadius = "0 2px 2px 0";
      right.style.background = "transparent";
    }
  }, 0);
}

function setupWaveSurfer(blobUrl) {
  if (ws) ws.destroy();
  regions = RegionsPlugin.create();
  ws = WaveSurfer.create({
    container: waveform,
    waveColor: "#43cea2",
    progressColor: "#185a9d",
    height: 160,
    url: blobUrl,
    plugins: [regions],
    responsive: true,
  });
  ws.on('ready', () => {
    const dur = ws.getDuration();
    const region = regions.addRegion({
      start: 0,
      end: Math.max(2, dur),
      color: "rgba(63,23,39,0.35)",
      drag: true,
      resize: true,
      content: "RESIZE ME!"
    });
    styleHandles(region);
  });

  // Play region and stop at end, no matter what
  regions.on("region-clicked", (region, e) => {
    e.stopPropagation();
    ws.play(region.start);

    // Remove old listener
    ws.un("timeupdate");

    ws.on("timeupdate", () => {
      if (ws.getCurrentTime() >= region.end) {
        ws.pause();
        ws.seekTo(region.end / ws.getDuration());
        ws.un("timeupdate");
      }
    });
  });

  regions.on("region-created", (region) => {
    styleHandles(region);
  });
}

recordBtn.onclick = async () => {
  if (!isRecording) {
    recordBtn.textContent = "Stopp opptak";
    isRecording = true;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new window.MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      if (audioUrl) URL.revokeObjectURL(audioUrl);
      audioUrl = URL.createObjectURL(blob);
      setupWaveSurfer(audioUrl);
      hint.style.display = "block";
      resetBtn.style.display = "inline-block";
      tips.style.display = "block";
      recordBtn.style.display = "none";
    };
    mediaRecorder.start();
  } else {
    recordBtn.textContent = "Start opptak";
    isRecording = false;
    mediaRecorder.stop();
  }
};

resetBtn.onclick = () => {
  if (audioUrl) URL.revokeObjectURL(audioUrl);
  if (ws) ws.destroy();
  hint.style.display = tips.style.display = "none";
  resetBtn.style.display = "none";
  recordBtn.style.display = "inline-block";
  waveform.innerHTML = "";
};
